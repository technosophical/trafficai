<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Upload | Ecoustics</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script src="https://apis.google.com/js/api.js"></script>
  <script>
    const API_BASE = "https://trafficai-1.onrender.com"; 
    const GOOGLE_CLIENT_ID = '380466288422-2smvpbn9f0h5ka4omjrmfdpg19ovvdts.apps.googleusercontent.com'; 

    let pickerApiLoaded = false;
    let oauthToken = '';

    function loadPicker() {
      gapi.load('auth2', () => {
        gapi.auth2.init({
          client_id: GOOGLE_CLIENT_ID
        }).then(authInstance => {
          authInstance.signIn().then(user => {
            oauthToken = user.getAuthResponse().access_token;
            createPicker();
          });
        });
      });
    }

    function createPicker() {
      gapi.load('picker', {'callback': onPickerApiLoad});
    }

    function onPickerApiLoad() {
      pickerApiLoaded = true;
      if (pickerApiLoaded && oauthToken) {
        const picker = new google.picker.PickerBuilder()
          .addView(google.picker.ViewId.DOCS)
          .setOAuthToken(oauthToken)
          .setDeveloperKey('AIzaSy...')  <!-- (Optional: real API Key here for better stability but can omit) -->
          .setCallback(pickerCallback)
          .build();
        picker.setVisible(true);
      }
    }

    function pickerCallback(data) {
      if (data.action === google.picker.Action.PICKED) {
        const fileId = data.docs[0].id;
        const downloadUrl = `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`;

        alert('✅ File selected from Google Drive. (Integration pending file handling.)');
        // Future: fetch file content and pass to API
      }
    }

    async function uploadAudio() {
      const fileInput = document.getElementById('audioFile');
      const file = fileInput.files[0];

      if (!file) {
        alert("Please select a file first.");
        return;
      }
      if (file.size > 200 * 1024 * 1024) {
        alert("File too large! Max 200MB.");
        return;
      }

      const formData = new FormData();
      formData.append("audio_file", file);

      const uploadResponse = await fetch(`${API_BASE}/upload`, {
        method: "POST",
        body: formData
      });

      const data = await uploadResponse.json();
      if (data.session_id) {
        const resultsResponse = await fetch(`${API_BASE}/results/${data.session_id}`);
        const resultsData = await resultsResponse.json();

        alert(`✅ Upload done. Detected vehicles: ${resultsData.timestamps_sec.length}`);
      } else {
        alert("Upload failed.");
      }
    }

    async function useSample() {
      const response = await fetch(`${API_BASE}/process_sample`);
      const data = await response.json();
      if (data.session_id) {
        const resultsResponse = await fetch(`${API_BASE}/results/${data.session_id}`);
        const resultsData = await resultsResponse.json();

        alert(`✅ Sample done. Detected vehicles: ${resultsData.timestamps_sec.length}`);
      } else {
        alert("Sample processing failed.");
      }
    }
  </script>
</head>

<body>

<h1>Upload your recording</h1>

<h2>Option 1: Upload manually</h2>
<input type="file" id="audioFile">
<br><br>
<button onclick="uploadAudio()">Upload Audio</button>

<h2>Option 2: Try sample</h2>
<button onclick="useSample()">Try Sample</button>

<h2>Option 3: Upload from Google Drive</h2>
<button onclick="loadPicker()">Select from Google Drive</button>

</body>
</html>
